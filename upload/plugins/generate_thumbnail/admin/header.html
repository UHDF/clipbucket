<script type="text/javascript">{literal}
	function genthumb_generate(){
		$('#genThumbModal .question').fadeOut('fast', function(){
			$('#genThumbModal .loading').fadeIn('fast');
			$('body').addClass('genThumbGeneration');
		});
		$('#genThumbModal .modal-footer').slideUp('fast');
		
		if($('#genThumbModal').hasClass('deleteThumb')){
			return deleteThumb();
		}
		
		var p = videojs('cb_video_js');
		var formData = {thumb_time:p.currentTime(), video_id:$('#videoid').val()};
		$.ajax({
			type: 'POST',
			url: '../plugins/generate_thumbnail/create_thumbnail.php',
			data: formData,
			success: function(q){
				q = $.parseJSON(q);
				$('body').removeClass('genThumbGeneration');
				if(q.error !== ''){
					$('#genThumbModal .alert').html(q.error);
					$('#genThumbModal .loading').fadeOut('fast', function(){
						$('#genThumbModal .alert').fadeIn('fast');
					});
				} else if(q.res !== ''){
					if($('#vidm-video ul.ace-thumbnails li').length === 1 && /processing.jpg$/.test($('#vidm-video ul.ace-thumbnails li:first-child img').attr('src'))){
						$('#vidm-video ul.ace-thumbnails').html('');
					}
					
					$('#vidm-video ul.ace-thumbnails').append(q.res);
					askBeforeDeleteThumb($('#vidm-video ul.ace-thumbnails li:last-child .tools a'));
					$('#genThumbModal').modal('hide');
				}
			}
		});
	}

	function genthumb_addModal(){
		var modal = '<div class="modal fade" id="genThumbModal" tabindex="-1" role="dialog" aria-labelledby="genThumbModalLabel">'
		modal += '<div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header">';
		modal += '<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>';
		modal += '<h4 class="modal-title" id="genThumbModalLabel"></h4></div>';
		modal += '<div class="modal-body"><p class="question"></p>';
		modal += '<div class="loading"><p></p><div class="gtspinner"><div class="bounce1"></div><div class="bounce2"></div><div class="bounce3"></div></div></div>';
		modal += '<div class="alert alert-danger"></div></div>';
		modal += '<div class="modal-footer"><button type="button" class="btn btn-default" data-dismiss="modal">{/literal}{lang('cancel')}{literal}</button>';
		modal += '<button type="button" class="btn btn-primary btn-ok">Ok</button></div></div></div></div>';

		$('body').append(modal);
		$('#genThumbModal button.btn-ok').click(genthumb_generate);
	}

	function genthumb_addBtn($target){
		var btn = '<button type="button" class="btn btn-sm btn-primary" id="generateThumbnailAtTime">{/literal}{lang('genThumb_btn')}{literal}</button>';
		$target.prepend(btn);
		genthumb_addModal();
		btn = $('#generateThumbnailAtTime');
		btn.click(function(e){
			$('#genThumbModal h4#genThumbModalLabel').html('{/literal}{lang('genThumb_modalTitle')}{literal}');
			$('#genThumbModal .modal-body .question').html('{/literal}{lang('genThumb_modalBody')}{literal}');
			$('#genThumbModal .modal-body .loading p').html('{/literal}{lang('genThumb_modalBody2')}{literal}');
			$('#genThumbModal').modal();
		});

		$('#genThumbModal').on('hide.bs.modal', function(e){
			if($('body').hasClass('genThumbGeneration')){
				e.preventDefault();
				e.stopImmediatePropagation();
				return false;
			}
			$('#genThumbModal .modal-footer').css('display', 'block');
			$('#genThumbModal .question').css('display', 'block');
			$('#genThumbModal .loading').css('display', 'none');
			$('#genThumbModal .alert').css('display', 'none').html('');
			
			$('#vidm-video ul.ace-thumbnails .tools a').removeAttr('id');
		});
	}
	
	function deleteThumb(){
		var _this = $('#vidm-video ul.ace-thumbnails .tools a#thumbToDelete')
		var toDel = _this.closest('.tools').find('input').val();
		var next = '';
		if(_this.closest('ul').find('li').length > 1){
			if(_this.closest('.tools').find('input').is(':checked')) next = 'checked';
			else next = 'none';
		}
		var li = _this.closest('li');
		$.ajax({
			type: 'POST',
			url: '../plugins/generate_thumbnail/delete_thumbnail.php',
			data: {id: $('#videoid').val(), 'd': toDel, 'n': next},
			success: function(q){
				$('body').removeClass('genThumbGeneration');
				q = $.parseJSON(q);
				
				if(q.error !== ''){
					$('#genThumbModal .alert').html(q.error);
					$('#genThumbModal .loading').fadeOut('fast', function(){
						$('#genThumbModal .alert').fadeIn('fast');
					});
				} else if(q.res !== ''){
					if(q.res === 'last'){
						var last = li.closest('ul').find('li:last-child');
						if(li.html() === last.html()) last = last.prev();
						last.find('.tools input').prop('checked', true);
					} else {
						li.closest('ul').append(q.res);
					}
					li.remove();
					$('#genThumbModal').removeClass('deleteThumb');
					$('#genThumbModal').modal('hide');
				}
			}
		});
	}
	
	function askBeforeDeleteThumb($a){
		$a.click(function(e){
			e.preventDefault();
			$(this).attr('id', 'thumbToDelete');
			$('#genThumbModal h4#genThumbModalLabel').html('{/literal}{lang('genThumb_modalTitle2')}{literal}');
			$('#genThumbModal .modal-body .question').html('{/literal}{lang('genThumb_modalBody3')}{literal}');
			$('#genThumbModal .modal-body .loading p').html('{/literal}{lang('genThumb_modalBody4')}{literal}');
			$('#genThumbModal').addClass('deleteThumb');
			$('#genThumbModal').modal('show');
			/*if(confirm('Voulez-vous supprimer cette miniature ?')){
				var toDel = $(this).closest('.tools').find('input').val();
				var next = '';
				if($(this).closest('ul').find('li').length > 1){
					if($(this).closest('.tools').find('input').is(':checked')) next = 'checked';
					else next = 'none';
				}
				var li = $(this).closest('li');
				$.ajax({
					type: 'POST',
					url: '../plugins/generate_thumbnail/delete_thumbnail.php',
					data: {id: $('#videoid').val(), 'd': toDel, 'n': next},
					success: function(q){
						q = $.parseJSON(q);
						
						if(q.error !== ''){
							$('#genThumbModal .alert').html(q.error);
							$('#genThumbModal .loading').fadeOut('fast', function(){
								$('#genThumbModal .alert').fadeIn('fast');
							});
						} else if(q.res !== ''){
							if(q.res === 'last'){
								var last = li.closest('ul').find('li:last-child');
								if(li.html() === last.html()) last = last.prev();
								last.find('.tools input').prop('checked', true);
							} else {
								li.closest('ul').append(q.res);
							}
							li.remove();
							//$('#genThumbModal').modal('hide');
						}
					}
				});
			}*/
		});
	}
	
	function changeDeleteThumb(){
		$('#vidm-video ul.ace-thumbnails .tools').each(function(index){
			askBeforeDeleteThumb($(this).find('a'));
		});
	}

	$(function(){
		if($('#vidm-video .vidm-thumbs div.actions').length){
			genthumb_addBtn($('#vidm-video .vidm-thumbs div.actions'));
			changeDeleteThumb();
		}
	});
{/literal}</script>

<style>
	#genThumbModal .modal-body{ min-height: 80px; }
	#genThumbModal .loading, #genThumbModal .alert{ display: none; position: absolute; top: 20px; left: 20px; right: 20px; bottom: 20px; text-align: center; }
	#genThumbModal .btn{ border-width: 1px; min-width: 80px; }

	/** Spinner by @tobiasahlin (http://tobiasahlin.com/spinkit/) **/
	#genThumbModal .gtspinner{ margin: 10px auto 0; width: 70px; text-align: center; }
	#genThumbModal .gtspinner > div{ width: 10px; height: 10px; background-color: #333; border-radius: 100%; display: inline-block; -webkit-animation: gtSpin 1.4s infinite ease-in-out both; animation: gtSpin 1.4s infinite ease-in-out both; }
	#genThumbModal .gtspinner .bounce1{ -webkit-animation-delay: -0.32s; animation-delay: -0.32s; }
	#genThumbModal .gtspinner .bounce2{ -webkit-animation-delay: -0.16s; animation-delay: -0.16s; }

	@-webkit-keyframes gtSpin {
	  0%, 80%, 100% { -webkit-transform: scale(0) }
	  40% { -webkit-transform: scale(1.0) }
	}

	@keyframes gtSpin {
	  0%, 80%, 100% { -webkit-transform: scale(0); transform: scale(0);
	  } 40% { -webkit-transform: scale(1.0); transform: scale(1.0); }
	}
</style>