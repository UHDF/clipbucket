{literal}
<script language="JavaScript">


	/**
	*	Migrate the input into one textarea
	*	The purpose of this function is to avoid the post input limit
	*/
	function movemarker(){
		var nb = document.querySelector("#nbMarker");
		var data = document.querySelector("#dataTime");
		var submarker = document.querySelector("#submarker");
		
		var prevdata = data.value.split(";");

		submarker.value = '';
		
		for (i = 0; i < parseInt(nb.value); i++){

			var id = i+1;
			console.log(i);
			var tmpdata = prevdata[i].split(",");
			var phrase = document.querySelector("#phrase"+id).value;
			var subpos = $('input[name="options'+id+'"]:checked').val();

			submarker.value += tmpdata[1]+"\t"+tmpdata[2]+"\t"+tmpdata[0]+"\t"+phrase.trim()+"\t";

			if (subpos != "undefined"){
				submarker.value += subpos;
			}

			submarker.value += "\n";

		}

	}


	// get selection
	/*
	$('.colors input[type=radio]').on('change', function() {
		console.log(this.value);
	});
	*/



	/**
	*	Information about subtitle rules when input is modified.
	*/
	function draftProgress(){
		var nb = document.querySelector("#nbMarker");
		var progressBar = document.querySelector("#draftEtat");
		var plop = document.querySelector("#draftProgressBar");


		var how = 0;

		for (i = 1; i <= parseInt(nb.value); i++){
			if (document.querySelector("#phrase"+i).value != ''){
				how = how + 1;
			}
		}

		progressBar.innerHTML = how + " / " + nb.value;
		plop.value = how;

	}



	/**
	*	Information about subtitle rules when input is modified.
	*/
	function infoSub(id){
		var input = document.querySelector("#phrase"+id);
		var msg = document.querySelector("#subinfo"+id);
		var error = '';

		if (input.value.length > 72){
			error = "Trop de caractère, scindé le sous-titre.";
		}
		else{
			if (input.value.length > 36){
				error = "2 lignes";
			}
		}

		msg.innerHTML = error;
	}


	/**
	*	MAIN PROGRAM
	*/


	/**
	*	GENERAL VAR
	*/
	video = videojs('cb_video_js');
	var timeListener;

	/**
	*	Stop looping on video
	*/
	function inputStop(){

		if (timeListener) {
			// Remove previous timeListener function, if there is one
			// For HTML 5
			// video.removeEventListener('timeupdate', timeListener, false);
			// For Video JS 
			video.off('timeupdate', timeListener);
		}
		video.pause();

	}

	/**
	*	Loop on video
	*/
	function inputPlay(begin, end) {

		// For Video JS
		video.currentTime(begin);
		// For HTML 5
		// video.currentTime = begin;
		video.play();

		if (timeListener) {
			// Remove previous timeListener function, if there is one
			// For HTML 5
			// video.removeEventListener('timeupdate', timeListener, false);
			// For Video JS
			video.off('timeupdate', timeListener);
		}

		// Make a new function and save it for later as timeListener
		timeListener = function () {
			if (video.currentTime() > end){
				video.currentTime(begin);
			}

		};
		// For HTML 5
		// video.addEventListener('timeupdate', timeListener);
		// For Video JS
		video.on('timeupdate', timeListener);
	}


	/**
	*	AJAX call the php script that will generate the marker file
	*/
	function soundFinder(){

		var formData = {
			video: $("#video").val(),
			marker: $("#marker").val(),
			ffmpeg_path: $("#ffmpeg_path").val(),
			threshold: $("#threshold").val(),
			durationSilence: $("#durationSilence").val(),
			delayBefore: $("#delayBefore").val(),
			delayAfter: $("#delayAfter").val()
		};

		$("#soundFinderResult").html('<p>Traitement en cours...</p>');
		$.ajax({
			type	  	: "POST",
			url 	  	: "{/literal}{$baseurl}{literal}/plugins/mk_subtitle/sound_finder.php",
			data		: formData,
			dataType	: "html",
			beforeSend : function(q){
				document.querySelector("#draftProgressBar").removeAttribute('value');
			},
			success : function(q)
			{	
				var result = q;
				var i = 0;
				var ret = '';

				var dataTime = document.querySelector("#dataTime");

				dataTime.value = '';


				var object = $.parseJSON(result);

				for (i = 0; i < object.phrases.length; i++){

					ret += mkInput(object.phrases[i].id, object.phrases[i].humanbegin, object.phrases[i].begin, object.phrases[i].tbegin, object.phrases[i].humanend, object.phrases[i].end, object.phrases[i].tend, object.phrases[i].duration, object.phrases[i].onfocus);

					dataTime.value += object.phrases[i].id+","+object.phrases[i].begin+","+object.phrases[i].end+";";
				}

				$("#soundFinderResult").html(ret);
				$("#nbMarker").val(object.nbmarker);

				$("#draftEtat").html('0 / ' + object.nbmarker);
				document.querySelector("#draftProgressBar").max = object.nbmarker;
				document.querySelector("#draftProgressBar").value = 0;
			}
		});
	}


	function mkInput(id, humanbegin, begin, tbegin, humanend, end, tend, duration, onfocus){

		return '<div class="control-group"><div class="row"><div class="col-md-12"><label for="phrase'+id+'" class="control-label">'+tbegin+' --> '+tend+' - duration : '+duration+'</label></div></div><div class="row"><div class="col-md-9"><div class="form-inline"><input type="text"  class="form-control" name="phrase'+id+'" id="phrase'+id+'" onfocus="'+onfocus+';" onblur="inputStop();draftProgress();" onkeyup="infoSub('+id+');" value="" spellcheck="true"><span id="subinfo'+id+'" class="help-inline"></span></div></div><div class="col-md-3"><div class="btn-group colors" data-toggle="buttons"><label class="btn btn-primary btn-xs"><input type="radio" name="options'+id+'" value="left" autocomplete="off"> Gauche</label><label class="btn btn-primary btn-xs active"><input type="radio" name="options'+id+'" value="" autocomplete="off" checked> Centre</label><label class="btn btn-primary btn-xs"><input type="radio" name="options'+id+'" value="right" autocomplete="off"> Droite</label></div></div></div></div>';

	}


	/*
		Testing dynamically adding the subtitle.
	*/
	var track;

	function myAddCue(){

		var nb = $("#nbMarker").val();		// Count of the input text.
		var data =  $("#dataTime").val();	// Input with all the time in and out by ID.
		var timecode = data.split(";");		// Explode the data to get an array for each phrase.

		var b;	// The var to put the new cue.
		for (i = 0; i < (timecode.length-1); i++){

			var a = timecode[i].split(",");	// Explode the timecode
			var phrase = $("#phrase"+a[0]).val();	// Get the content of timecode.

			if (phrase != ''){	// If there is a content, we put it in the cue.
				var b = new VTTCue(a[1], a[2], phrase);		// make the object cue.
				track.addCue(b);	// add the object.
			}
		}

		track.mode = "showing";	// Display/Select the track.
	}


	function myRemoveCue(){

		var myCues = track.cues;		// array of current cues.
		var i = myCues.length;			// Cues size

		if (i > 0) {		// If array not empty
			do {
				track.removeCue(myCues[i]);	// Remove the object from cue list.
				i = i - 1;
			} while (i >= 0);
		}

		track.mode = "disabled";		// Hide the subtitle
	}	// En of myRemoveCue


/*

	myCues[0].startTime						// Get time in of the cue
	myCues[0].endTime						// Get time in of the cue
	myCues[0].getCueAsHTML().textContent;	// Get the text of the cue

*/

	/*
		Button Listener
	*/

	document.querySelector('#btnOverview').addEventListener('click', function(e){
		myRemoveCue();
		myAddCue();
	});


</script>
{/literal}