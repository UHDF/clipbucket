{literal}
<script language="JavaScript">


	/**
	*	Migrate the input into one textarea
	*	The purpose of this function is to avoid the post input limit
	*/
	function movemarker(){
		var nb = document.querySelector("#nbMarker");
		var data = document.querySelector("#dataTime");
		var submarker = document.querySelector("#submarker");

		var prevdata = data.value.split(";");

		submarker.value = '';

		for (i = {/literal}{(($page-1)*100)}{literal}; i <= parseInt({/literal}{((($page-1)*100)+100)-1}{literal}); i++){
		// for (i = 0; i < parseInt(nb.value); i++){

			if ({/literal}{$page}{literal} == 1){
				var id = i+1;
			}
			else{
				var id = i;
			}

			var tmpdata = prevdata[id-1].split(",");
			var phrase = document.querySelector("#phrase"+id).value;
			var subpos = $('input[name="options'+id+'"]:checked').val();

			submarker.value += tmpdata[1]+"\t"+tmpdata[2]+"\t"+tmpdata[0]+"\t"+phrase.trim()+"\t";

			if (subpos != "undefined"){
				submarker.value += subpos;
			}

			submarker.value += "\n";

		}

	}


	/**
	*	Information about subtitle rules when input is modified.
	*/
	function draftProgress(valeur, old){
		var nb = document.querySelector("#nbMarker");
		var progressBar = document.querySelector("#draftEtat");
		var bar = document.querySelector("#draftProgressBar");

		var how = bar.value;

		if ((valeur != '') && (old == '')){
			how = how + 1;
		}

		if (valeur == ''){
			how = how - 1;
		}

		progressBar.innerHTML = how + " / " + nb.value;
		bar.value = how;

	}

	/**
	*	Submit form if enter key is pressed
	*/
	function enterPostForm(event){
		// The form
		var submitForm = document.querySelector("#realDraftForm");
		// Get CharCode
		char = event.which || event.keyCode;

		// If keyboard event is "enter"
		if (char == 13){
			// Create a input to post name of the submit button
			var input = document.createElement("input");
			input.type = "hidden";
			input.name = "saveMarker";
			input.value = "sauvegarde";
			submitForm.appendChild(input);
			// Move all input into a textarea in order to post only one input
			movemarker();
			// Submit form
			submitForm.submit();
		}
	}

	/**
	*	Information about subtitle rules when input is modified.
	*/
	function infoSub(id){
		var input = document.querySelector("#phrase"+id);
		var msg = document.querySelector("#subinfo"+id);
		var error = '';

		if (input.value.length > 72){
			error = "Trop de caractère, scindé le sous-titre.";
		}
		else{
			if (input.value.length > 36){
				error = "2 lignes";
			}
		}

		// TODO: ask for time needed

		// If no error at this time, test to check if length is enough
		/*
		if (error == ''){
			input.value.length
		}
		*/

		msg.innerHTML = error;
	}


	/**
	*	MAIN PROGRAM
	*/


	/**
	*	GENERAL VAR
	*/
	video = videojs('cb_video_js');
	var timeListener;

	/**
	*	Stop looping on video
	*/
	function inputStop(){

		if (timeListener) {
			// Remove previous timeListener function, if there is one
			// For HTML 5
			// video.removeEventListener('timeupdate', timeListener, false);
			// For Video JS
			video.off('timeupdate', timeListener);
		}
		video.pause();

	}

	/**
	*	Loop on video
	*/
	function inputPlay(begin, end) {

		// For Video JS
		video.currentTime(begin);
		// For HTML 5
		// video.currentTime = begin;
		video.play();

		if (timeListener) {
			// Remove previous timeListener function, if there is one
			// For HTML 5
			// video.removeEventListener('timeupdate', timeListener, false);
			// For Video JS
			video.off('timeupdate', timeListener);
		}

		// Make a new function and save it for later as timeListener
		timeListener = function () {
			if (video.currentTime() > end){
				video.currentTime(begin);
			}

		};
		// For HTML 5
		// video.addEventListener('timeupdate', timeListener);
		// For Video JS
		video.on('timeupdate', timeListener);
	}


	/**
	*	AJAX call the php script that will generate the marker file
	*/
	function soundFinder(){

		var formData = {
			video: $("#video").val(),
			marker: $("#marker").val(),
			ffmpeg_path: $("#ffmpeg_path").val(),
			threshold: $("#threshold").val(),
			durationSilence: $("#durationSilence").val(),
			delayBefore: $("#delayBefore").val(),
			delayAfter: $("#delayAfter").val()
		};

		$("#soundFinderResult").html('<p>Traitement en cours...</p>');
		$.ajax({
			type	  	: "POST",
			url 	  	: "{/literal}{$baseurl}{literal}/plugins/mk_subtitle/sound_finder.php",
			data		: formData,
			dataType	: "html",
			beforeSend : function(q){
				document.querySelector("#draftProgressBar").removeAttribute('value');
			},
			success : function(q)
			{
				var result = q;
				var i = 0;
				var ret = '';

				var dataTime = document.querySelector("#dataTime");

				dataTime.value = '';


				var object = $.parseJSON(result);

				for (i = 0; i < object.phrases.length; i++){

					ret += mkInput(object.phrases[i].id, object.phrases[i].begin, object.phrases[i].tbegin, object.phrases[i].end, object.phrases[i].tend, object.phrases[i].duration);

					dataTime.value += object.phrases[i].id+","+object.phrases[i].begin+","+object.phrases[i].end+";";
				}

				$("#soundFinderResult").html(ret);
				$("#nbMarker").val(object.nbmarker);

				$("#draftEtat").html('0 / ' + object.nbmarker);
				document.querySelector("#draftProgressBar").max = object.nbmarker;
				document.querySelector("#draftProgressBar").value = 0;
			}
		});
	}


	function mkInput(id, begin, tbegin, end, tend, duration){

		return '<div class="control-group"><div class="row"><div class="col-md-9"><div class="form-group"><label for="phrase'+id+'" class="control-label">'+tbegin+' --> '+tend+' - duration : '+duration+'</label><input type="text"  class="form-control" name="phrase'+id+'" id="phrase'+id+'" onfocus="inputPlay('+begin+','+end+');" onblur="inputStop();draftProgress();" onkeyup="infoSub('+id+');" value="" spellcheck="true"><span id="subinfo'+id+'" class="help-inline"></span></div></div><div class="col-md-3"><label class="control-label">Position</label><div class="btn-group colors" data-toggle="buttons"><label class="btn btn-primary btn-xs"><input type="radio" name="options'+id+'" value="left" autocomplete="off">Gauche</label><label class="btn btn-primary btn-xs active"><input type="radio" name="options'+id+'" value="" autocomplete="off" checked>Centre</label><label class="btn btn-primary btn-xs"><input type="radio" name="options'+id+'" value="right" autocomplete="off">Droite</label></div></div></div></div>';

	}


	/*
		Testing dynamically adding the subtitle.
	*/
	var track;

	function myAddCue(){
		if (!track){
			track = video.addTextTrack("subtitles", "French", "fr");
		}

		var nb = $("#nbMarker").val();		// Count of the input text.
		var data =  $("#dataTime").val();	// Input with all the time in and out by ID.
		var timecode = data.split(";");		// Explode the data to get an array for each phrase.

		var b;	// The var to put the new cue.
		for (i = 0; i < (timecode.length-1); i++){

			var a = timecode[i].split(",");	// Explode the timecode
			var phrase = $("#phrase"+a[0]).val();	// Get the content of timecode.

			if (phrase != ''){	// If there is a content, we put it in the cue.
				var b = new VTTCue(a[1], a[2], phrase);		// make the object cue.
				track.addCue(b);	// add the object.
			}
		}

		track.mode = "showing";	// Display/Select the track.
	}


	function myRemoveCue(){
		if (track){

			var myCues = track.cues;		// array of current cues.
			var i = myCues.length;			// Cues size

			if (i > 0) {		// If array not empty
				do {
					track.removeCue(myCues[i]);	// Remove the object from cue list.
					i = i - 1;
				} while (i >= 0);
			}

			track.mode = "disabled";		// Hide the subtitle
		}
	}	// En of myRemoveCue


/*

	myCues[0].startTime						// Get time in of the cue
	myCues[0].endTime						// Get time in of the cue
	myCues[0].getCueAsHTML().textContent;	// Get the text of the cue

*/

	/*
		Button Listener
	*/

	document.querySelector('#btnOverview').addEventListener('click', function(e){
		myRemoveCue();
		myAddCue();
	});

	document.querySelector('#btnAddlang').addEventListener('click', function(e){

		// Remove tab active style
		removeActiveStyle('#otherlangtab');

		// Remove tab content active style
		removeActiveStyle('#otherlangcontent');

		var codelang = document.querySelector('#newLang').value;

		if ( document.querySelector('#tab-'+codelang) == null ){
			// Tab
			var newTab = document.createElement("li");
				newTab.setAttribute('class', 'active');
				newTab.setAttribute('id', 'tab-'+codelang);

			var newLink = document.createElement("a");
				newLink.setAttribute('data-toggle', 'tab');
				newLink.setAttribute('href', '#'+codelang);
				newLink.setAttribute('id', 'link-'+codelang);
				newLink.setAttribute('title', document.querySelector('#newLang').options[document.querySelector('#newLang').selectedIndex].innerHTML);

			var text = document.createTextNode(codelang);

			document.querySelector('#otherlangtab').appendChild(newTab)
			document.querySelector('#tab-'+codelang).appendChild(newLink)
			document.querySelector('#link-'+codelang).appendChild(text)

			// Content
			var divContent = document.createElement("div");
				divContent.setAttribute('id', codelang);
				divContent.setAttribute('class', 'tab-pane active');

			var divTextarea = document.createElement("textarea");
				divTextarea.setAttribute('id', 'txtarea-'+codelang);
				divTextarea.setAttribute('class', 'form-control')
				divTextarea.setAttribute('name', 'otherSubtitle['+codelang+']')
				divTextarea.setAttribute('onscroll', 'this.form.elements.subdata.scrollTop=this.scrollTop;')
				divTextarea.setAttribute('cols', '80')
				divTextarea.setAttribute('rows', '20')

			var text = document.createTextNode(delSentenceFromWebVTT(document.querySelector('#subdata').value));

			document.querySelector('#otherlangcontent').appendChild(divContent)
			document.querySelector('#'+codelang).appendChild(divTextarea)
			document.querySelector('#txtarea-'+codelang).appendChild(text)

		}
		else{
			document.querySelector('#tab-'+codelang).classList.add("active");
			document.querySelector('#'+codelang).classList.add("active");
		}

	});


	function removeActiveStyle(parentNode){
		// Remove active style
		var tablist = document.querySelector(parentNode).childNodes
		if (tablist.length > 1){
			for (var i = 0; i < tablist.length; i++) {
				if (tablist[i].classList){
					tablist[i].classList.remove("active")
				}
			}
		}
	}

	function delSentenceFromWebVTT(){

		var tableau = document.querySelector('#subdata').value.split("\n");
		var chaine = '';

		for (var i = 0; i < tableau.length; i++){

			if (tableau[i] == 'WEBVTT'){
				chaine += "WEBVTT";
			}
			else{
				if (tableau[i].indexOf("-->") > -1){
					chaine += tableau[i];
				}
			}
			chaine += "\n";

		}
		return chaine;
	}


	function autosavedraft(){

		movemarker();
		var markerfile = document.querySelector("#marker").value;
		var submarker = document.querySelector("#submarker").value;

		var formData = {markerfile:markerfile,submarker:submarker};
		$.ajax({
			type	  	: "POST",
			url 	  	: "{/literal}{$baseurl}{literal}/plugins/mk_subtitle/autosavedraft.php",
			data		: formData,
			success : function(q)
			{
				if (q){
					document.querySelector("#autosavestatut").innerHTML = q;
				}
			}
		});
	}


</script>
{/literal}