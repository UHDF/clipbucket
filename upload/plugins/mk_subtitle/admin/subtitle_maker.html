<h2>{lang code="mksub_title"}</h2>

<div class="row">
	<!-- 	PLAYER VIDEO 	-->
	<div class="col-md-6">
		{FlashPlayer vdetails=$data width='100%' height='100%' }
	</div>
	<div class="col-md-6">

		<!-- Button trigger modal -->
		<button type="button" class="btn btn-primary btn-sm pull-right" data-toggle="modal" data-target="#helpSubtitle">{lang code="help"}</button>

		<div id="soundFinder">

			<input type="hidden" name="video" id="video" size="80" value="{$video_file}">
			<input type="hidden" name="marker" id="marker" size="80" value="{$marker_file}">
			<input type="hidden" name="ffmpeg_path" id="ffmpeg_path" size="80" value="{$ffmpeg_path}">

			<label for="threshold">{lang code="mksub_threshold"} : </label>
			<input type="text" name="threshold" id="threshold" size="2" value="{$threshold}">dB<br>
			<label for="durationSilence">{lang code="mksub_silencedurationmin"} : </label>
			<input type="text" name="durationSilence" id="durationSilence" size="5" value="{$durationSilence}">{lang code="seconds"}<br>
			<label for="delayBefore">{lang code="mksub_startplaying"} : </label>
			<input type="text" name="delayBefore" id="delayBefore" size="5" value="{$delayBefore}">{lang code="seconds"}<br>
			<label for="delayAfter">{lang code="mksub_stopplaying"} : </label>
			<input type="text" name="delayAfter" id="delayAfter" size="5" value="{$delayAfter}">{lang code="seconds"}<br>

			<button onclick="soundFinder();" title="Sound Finder">{lang code="mksub_findsentences"}</button><br>
			<br>
		</div>
		
	</div>
</div>

<br>

<div class="row">
	<div class="col-md-12">

		<div class="tabbable">
			<ul class="nav nav-tabs" id="myTab">
				<li class="{if $tabactive eq ''}active{/if}"><a data-toggle="tab" href="#draft">{lang code="mksub_draft"}</a></li>
				<li class="{if $tabactive == 'final'}active{/if}"><a data-toggle="tab" href="#final">{lang code="mksub_finalfile"}</a></li>
			</ul>

			<!-- 
				Edition des sous titres
			-->
			<div class="tab-content">
				<div id="draft" class="tab-pane{if $tabactive eq ''} active{/if}">
					<h2>{lang code="mksub_draft"}</h2>

					{lang code="mksub_state"} : <span id="draftEtat">{$savedSub} / {$nbMarker}</span><br>
					<progress id="draftProgressBar" value="{$savedSub}" max="{$nbMarker}" style="width: 100%;"></progress>

					<div id="soundFinderResult" style="overflow:scroll; overflow-x:hidden; height:400px;margin-bottom:10px;">
						
						{foreach from=$marker item=data}
						
						<div class="control-group">
							<div class="row">
								<div class="col-md-12">
									<label for="phrase{$data[2]}" class="control-label">
										{$data[6]} --> {$data[7]} - {lang code="duration"} : {$data[8]}
									</label>
								</div>
							</div>
							
							<div class="row">
								<div class="col-md-9">

									<div class="form-inline">
										
										<input type="text"  class="form-control" name="phrase{$data[2]}" id="phrase{$data[2]}" onfocus="inputPlay({$data[0]}, {$data[1]});" onblur="inputStop();draftProgress();" onkeyup="infoSub({$data[2]});" value="{$data[3]}" spellcheck="true">
										
										<span id="subinfo{$data[2]}" class="help-inline"></span>
									</div>
								
								</div>
								<div class="col-md-3">
										<!--
											Positionnement du sous titre
										-->
										<div class="btn-group colors" data-toggle="buttons">
											<label class="btn btn-primary btn-xs{if $data[9] eq 'left'} active{/if}">
												<input type="radio" name="options{$data[2]}" value="left" autocomplete="off"{if $data[9] eq 'left'} checked{/if}> Gauche
											</label>
											
											<label class="btn btn-primary btn-xs{if $data[9] eq ''} active{/if}">
											<input type="radio" name="options{$data[2]}" value="" autocomplete="off"{if $data[9] eq ''} checked{/if}> Centre
											</label>
											
											<label class="btn btn-primary btn-xs{if $data[9] eq 'right'} active{/if}">
												<input type="radio" name="options{$data[2]}" value="right" autocomplete="off"{if $data[9] eq 'right'} checked{/if}> Droite
											</label>
										</div>

								</div>

							</div>

						</div>
						
						{/foreach}
					</div>
					
					<div class="control-group">

						<form method="POST" class="form-horizontal" onsubmit="movemarker();">
							<!-- For dynamically construct the subtitle -->
							<input type="hidden" name="dataTime" id="dataTime" size="80" value="{foreach from=$marker item=data}{$data[2]},{$data[4]},{$data[5]};{/foreach}">

							<textarea name="submarker" id="submarker" cols="80" rows="20" style="display:none;left:-100000000px;"></textarea>
							<br>

							<!-- To construct the file -->
							<input type="hidden" name="nbMarker" id="nbMarker" value="{$nbMarker}">
							<input type="submit" name="saveMarker" class="btn btn-primary" value="{lang('saving')}">
							
							<input type="button" name="btnOverview" id="btnOverview" class="btn btn-primary" value="{lang('mksub_preview')}">

							<input type="submit" name="subtitlize" class="btn btn-primary" value="{lang('mksub_mksubfile')}">

						</form>
					</div>

<!--
		DEBUG
						<a href="#" onclick="javascript:myAddCue();">Test addCue</a>
						<a href="#" onclick="javascript:myRemoveCue();">Remove all Cue</a>
-->

				</div>

				<!-- 
					Fichier final
				-->
				<div id="final" class="tab-pane{if $tabactive == 'final'} active{/if}">
					
					<h2>{lang code="mksub_finalfile"}</h2>
					<p>{lang code="mksub_finalfiledesc"}</p>
				
					{if $subfile neq ''}
						<form method="POST">
							<div class="control-group">
								<textarea name="subdata" id="subdata" cols="80" rows="20">{$subfile}</textarea><br>
								<br>
								<input type="submit" name="saveSubtitle" class="btn btn-primary" value="{lang('saving')}">
								<input type="submit" name="deleteSubtitle" class="btn btn-primary" value="{lang('remove')}">
							</div>
						</form>
					{/if}
					
				</div>

			</div>
		</div>

	</div>
</div>



<!-- Temporary help -->
<div class="modal fade" id="helpSubtitle" tabindex="-1" role="dialog" aria-labelledby="helpSubtitleLabel">
	<div class="modal-dialog" role="document">
		<div class="modal-content">

			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title" id="myModalLabel">{lang code="mksub_title"} : {lang code="help"}</h4>
			</div>

			<div class="modal-body">
				{lang code="mksub_helpcontent"}
			</div>

			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">{lang code="mksub_close"}</button>
			</div>
		</div>
	</div>
</div>




{literal}
<script language="JavaScript">


	/**
	*	Migrate the input into one textarea
	*	The purpose of this function is to avoid the post input limit
	*/
	function movemarker(){
		var nb = document.querySelector("#nbMarker");
		var data = document.querySelector("#dataTime");
		var submarker = document.querySelector("#submarker");
		
		var prevdata = data.value.split(";");

		submarker.value = '';
		
		for (i = 0; i < parseInt(nb.value); i++){

			var id = i+1;
			console.log(i);
			var tmpdata = prevdata[i].split(",");
			var phrase = document.querySelector("#phrase"+id).value;
			var subpos = $('input[name="options'+id+'"]:checked').val();

			submarker.value += tmpdata[1]+"\t"+tmpdata[2]+"\t"+tmpdata[0]+"\t"+phrase.trim()+"\t";

			if (subpos != "undefined"){
				submarker.value += subpos;
			}

			submarker.value += "\n";

		}

	}


	// get selection
	/*
	$('.colors input[type=radio]').on('change', function() {
		console.log(this.value);
	});
	*/



	/**
	*	Information about subtitle rules when input is modified.
	*/
	function draftProgress(){
		var nb = document.querySelector("#nbMarker");
		var progressBar = document.querySelector("#draftEtat");
		var plop = document.querySelector("#draftProgressBar");


		var how = 0;

		for (i = 1; i <= parseInt(nb.value); i++){
			if (document.querySelector("#phrase"+i).value != ''){
				how = how + 1;
			}
		}

		progressBar.innerHTML = how + " / " + nb.value;
		plop.value = how;

	}



	/**
	*	Information about subtitle rules when input is modified.
	*/
	function infoSub(id){
		var input = document.querySelector("#phrase"+id);
		var msg = document.querySelector("#subinfo"+id);
		var error = '';

		if (input.value.length > 72){
			error = "Trop de caractère, scindé le sous-titre.";
		}
		else{
			if (input.value.length > 36){
				error = "2 lignes";
			}
		}

		msg.innerHTML = error;
	}


	/**
	*	MAIN PROGRAM
	*/


	/**
	*	GENERAL VAR
	*/
	video = videojs('cb_video_js');
	var timeListener;

	/**
	*	Stop looping on video
	*/
	function inputStop(){

		if (timeListener) {
			// Remove previous timeListener function, if there is one
			// For HTML 5
			// video.removeEventListener('timeupdate', timeListener, false);
			// For Video JS 
			video.off('timeupdate', timeListener);
		}
		video.pause();

	}

	/**
	*	Loop on video
	*/
	function inputPlay(begin, end) {

		// For Video JS
		video.currentTime(begin);
		// For HTML 5
		// video.currentTime = begin;
		video.play();

		if (timeListener) {
			// Remove previous timeListener function, if there is one
			// For HTML 5
			// video.removeEventListener('timeupdate', timeListener, false);
			// For Video JS
			video.off('timeupdate', timeListener);
		}

		// Make a new function and save it for later as timeListener
		timeListener = function () {
			if (video.currentTime() > end){
				video.currentTime(begin);
			}

		};
		// For HTML 5
		// video.addEventListener('timeupdate', timeListener);
		// For Video JS
		video.on('timeupdate', timeListener);
	}


	/**
	*	AJAX call the php script that will generate the marker file
	*/
	function soundFinder(){

		var formData = {
			video: $("#video").val(),
			marker: $("#marker").val(),
			ffmpeg_path: $("#ffmpeg_path").val(),
			threshold: $("#threshold").val(),
			durationSilence: $("#durationSilence").val(),
			delayBefore: $("#delayBefore").val(),
			delayAfter: $("#delayAfter").val()
		};

		$("#soundFinderResult").html('<p>Traitement en cours...</p>');
		$.ajax({
			type	  	: "POST",
			url 	  	: "../plugins/mk_subtitle/sound_finder.php",
			data		: formData,
			dataType	: "html",
			beforeSend : function(q){
				document.querySelector("#draftProgressBar").removeAttribute('value');
			},
			success : function(q)
			{	
				var result = q;
				var i = 0;
				var ret = '';

				var dataTime = document.querySelector("#dataTime");

				dataTime.value = '';


				var object = $.parseJSON(result);

				for (i = 0; i < object.phrases.length; i++){

					ret += mkInput(object.phrases[i].id, object.phrases[i].humanbegin, object.phrases[i].begin, object.phrases[i].tbegin, object.phrases[i].humanend, object.phrases[i].end, object.phrases[i].tend, object.phrases[i].duration, object.phrases[i].onfocus);

					dataTime.value += object.phrases[i].id+","+object.phrases[i].begin+","+object.phrases[i].end+";";
				}

				$("#soundFinderResult").html(ret);
				$("#nbMarker").val(object.nbmarker);

				$("#draftEtat").html('0 / ' + object.nbmarker);
				document.querySelector("#draftProgressBar").max = object.nbmarker;
				document.querySelector("#draftProgressBar").value = 0;
			}
		});
	}


	function mkInput(id, humanbegin, begin, tbegin, humanend, end, tend, duration, onfocus){

		return '<div class="control-group"><div class="row"><div class="col-md-12"><label for="phrase'+id+'" class="control-label">'+tbegin+' --> '+tend+' - duration : '+duration+'</label></div></div><div class="row"><div class="col-md-9"><div class="form-inline"><input type="text"  class="form-control" name="phrase'+id+'" id="phrase'+id+'" onfocus="'+onfocus+';" onblur="inputStop();draftProgress();" onkeyup="infoSub('+id+');" value="" spellcheck="true"><span id="subinfo'+id+'" class="help-inline"></span></div></div><div class="col-md-3"><div class="btn-group colors" data-toggle="buttons"><label class="btn btn-primary btn-xs"><input type="radio" name="options'+id+'" value="left" autocomplete="off"> Gauche</label><label class="btn btn-primary btn-xs active"><input type="radio" name="options'+id+'" value="" autocomplete="off" checked> Centre</label><label class="btn btn-primary btn-xs"><input type="radio" name="options'+id+'" value="right" autocomplete="off"> Droite</label></div></div></div></div>';

	}





	/*
		Testing dynamically adding the subtitle.
	*/
	var track;

	function myAddCue(){

		var nb = $("#nbMarker").val();		// Count of the input text.
		var data =  $("#dataTime").val();	// Input with all the time in and out by ID.
		var timecode = data.split(";");		// Explode the data to get an array for each phrase.

		var b;	// The var to put the new cue.
		for (i = 0; i < (timecode.length-1); i++){

			var a = timecode[i].split(",");	// Explode the timecode
			var phrase = $("#phrase"+a[0]).val();	// Get the content of timecode.

			if (phrase != ''){	// If there is a content, we put it in the cue.
				var b = new VTTCue(a[1], a[2], phrase);		// make the object cue.
				track.addCue(b);	// add the object.
			}
		}

		track.mode = "showing";	// Display/Select the track.
	}


	function myRemoveCue(){

		var myCues = track.cues;		// array of current cues.
		var i = myCues.length;			// Cues size

        if (i > 0) {		// If array not empty
			do {
				track.removeCue(myCues[i]);	// Remove the object from cue list.
				i = i - 1;
			} while (i >= 0);
        }

		track.mode = "disabled";		// Hide the subtitle
	}	// En of myRemoveCue


/*

	myCues[0].startTime						// Get time in of the cue
	myCues[0].endTime						// Get time in of the cue
	myCues[0].getCueAsHTML().textContent;	// Get the text of the cue

*/

	/*
		Button Listener
	*/

	document.querySelector('#btnOverview').addEventListener('click', function(e){
		myRemoveCue();
		myAddCue();
	});


</script>
{/literal}
