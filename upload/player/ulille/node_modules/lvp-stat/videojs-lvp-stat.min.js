/**
 * videojs-lvp-stat
 * @version 0.0.0
 * @copyright 2017 Bastien <bastien.poirier@univ-lille1.fr>
 * @license MIT
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("video.js")):"function"==typeof define&&define.amd?define(["video.js"],e):t.videojsLvpStat=e(t.videojs)}(this,function(t){"use strict";var e=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},i=(t="default"in t?t["default"]:t).registerPlugin||t.plugin,n=function(){function t(i){e(this,t),this.player=i,this.defaults={},this.vid=undefined,this.uid=undefined,this.uri=undefined,this.lastTime=null,this.lastUpdate=null,this.token=null,this.canAjax=!0,this.isLive=!1,this.delay=10}return t.prototype.checkLive=function(){var t=this.player.currentSource(),e=t.type;e!==undefined?this.isLive=null!==e.match(/application\/(dash\+xml|x-mpegURL)/):t.src!==undefined&&(this.isLive=null!==t.src.match(/(mpd|m3u8)$/))},t.prototype.ajax=function(t){var e=this;console.log("Ajax : ",t);var i=!0;"exit"===t&&(i=!1,t="end"),$.ajax({async:i,method:"POST",url:this.uri,data:{vid:this.vid,uid:this.uid,live:this.isLive?1:0,status:t,timecode:this.lastTime,token:this.token}}).done(function(i){e.canAjax=!0,e.lastUpdate=e.lastTime,console.log(i),""!==i.error?console.log(i.error):"end"===t?e.token=null:i.token&&(e.token=i.token)})},t.prototype.start=function(t){t.lastTime=t.lastUpdate=t.player.currentTime(),t.ajax("start")},t.prototype.timeupdate=function(t){t.player.currentTime()-t.lastTime>1?t.end(t):(t.lastTime=t.player.currentTime(),t.lastTime-t.lastUpdate>=t.delay&&t.ajax("update"))},t.prototype.liveTimeupdate=function(t){return null===t.lastTime&&t.player.dash.mediaPlayer.on(dashjs.MediaPlayer.events.PLAYBACK_ENDED,function(){that.end(that)}),null===t.token?t.start(t):t.timeupdate(t)},t.prototype.end=function(t){null!==t.token&&(t.ajax("end"),t.lastTime=t.player.currentTime())},t.prototype.addEvent=function(t,e,i){t.addEventListener?t.addEventListener(e,i,!1):t.attachEvent&&t.attachEvent("on"+e,i)},t.prototype.onPlayerReady=function(t){if(this.player.addClass("vjs-lvp-stat"),window.jQuery){if(!t.vid||!t.uid||!t.uri)return t.vid||console.log("LVP Stat error: missing parameter vid"),t.uid||console.log("LVP Stat error: missing parameter uid"),void(t.uri||console.log("LVP Stat error: missing parameter uri"));t.delay&&(this.delay=t.delay),this.uid=t.uid,this.vid=t.vid,this.uri=t.uri,this.checkLive();var e=this;this.addEvent(window,"beforeunload",function(){e.ajax("exit")}),this.player.on("pause",function(){e.end(e)}),this.isLive?this.player.on("timeupdate",function(){e.liveTimeupdate(e)}):(this.player.on("play",function(){e.start(e)}),this.player.on("timeupdate",function(){e.timeupdate(e)}))}else console.log("LVP Stat error: jQuery is missing")},t}(),a=function(e){var i=this;this.ready(function(){var a=new n(i);a.onPlayerReady(t.mergeOptions(a.defaults,e))})};return i("lvpStat",a),a.VERSION="0.0.0",a});